<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pingo.mapper.LocationMapper">

    <select id="getUserLocation" resultType="com.pingo.entity.users.Userlocation">
        SELECT USERNO, latitude, longitude
        FROM user_locations
        WHERE USERNO = #{userNo}
    </select>

    <update id="updateUserLocation">
        MERGE INTO user_locations ul
        USING (
        SELECT #{userNo} AS userNo, #{latitude} AS latitude, #{longitude} AS longitude FROM dual
        ) dummy
        ON (ul.userNo = dummy.userNo)
        WHEN MATCHED THEN
        UPDATE SET ul.latitude = dummy.latitude, ul.longitude = dummy.longitude
        WHEN NOT MATCHED THEN
        INSERT (userNo, latitude, longitude)
        VALUES (dummy.userNo, dummy.latitude, dummy.longitude)
    </update>

    <select id="findNearbyUsers" resultType="com.pingo.dto.profile.MainProfileResponseDTO">
        SELECT
        "u"."userNo",
        "u"."userName",
        "ui"."userBirth",
        '접속중' AS "status",
        TO_CHAR(
        SDO_GEOM.SDO_DISTANCE(
        "ul"."LOCATION",
        (SELECT "LOCATION" FROM "USER_LOCATIONS" WHERE "USERNO" = #{userNo}),
        0.005,
        'unit=KM'
        ), 'FM990.00'
        ) || ' km' AS "distance",
        (SELECT COALESCE(LISTAGG("img"."imageUrl", ',') WITHIN GROUP (ORDER BY "img"."imageUrl"), '')
        FROM "userImage" "img"
        WHERE "img"."userNo" = "u"."userNo") AS "images"
        FROM "users" "u"
        JOIN "userInfo" "ui" ON "u"."userNo" = "ui"."userNo"
        JOIN "USER_LOCATIONS" "ul" ON "u"."userNo" = "ul"."USERNO"
        WHERE "u"."userNo" != #{userNo}
        -- 내 성별과 다른 유저만
        AND "u"."userGender" != (SELECT "userGender" FROM "users" WHERE "userNo" = #{userNo})
        -- 상태 및 권한 (DB 기본값)
        AND "u"."userState" = '1000'
        AND "u"."userRole" = 'ROLE_USER'

        -- SDO_DISTANCE 직접 비교 (XML 파싱 에러 방지를 위해 CDATA 적용)
        AND SDO_GEOM.SDO_DISTANCE(
        "ul"."LOCATION",
        (SELECT "LOCATION" FROM "USER_LOCATIONS" WHERE "USERNO" = #{userNo}),
        0.005,
        'unit=KM'
        ) <![CDATA[ <= ]]> ${distanceKm}

        -- 차단 유저 제외
        AND NOT EXISTS (
        SELECT 1 FROM "userBlock" "ub"
        WHERE "ub"."fromUserNo" = #{userNo}
        AND "ub"."toUserNo" = "u"."userNo"
        )
        -- 내가 PANG(패스)한 유저 제외
        AND NOT EXISTS (
        SELECT 1 FROM "swipe" "s"
        WHERE "s"."fromUserNo" = #{userNo}
        AND "s"."toUserNo" = "u"."userNo"
        AND "s"."swipeType" = 'PANG'
        )
        -- 이미 매칭된 유저 제외
        AND NOT EXISTS (
        SELECT 1 FROM "matchMapper" "mm"
        JOIN "matching" "m" ON "mm"."matchNo" = "m"."matchNo"
        WHERE "mm"."userNo" = #{userNo}
        AND "m"."matchState" = 'ACTIVE'
        AND "mm"."matchUserNo" = "u"."userNo"
        )
        ORDER BY SDO_GEOM.SDO_DISTANCE(
        "ul"."LOCATION",
        (SELECT "LOCATION" FROM "USER_LOCATIONS" WHERE "USERNO" = #{userNo}),
        0.005,
        'unit=KM'
        ) ASC
    </select>

</mapper>