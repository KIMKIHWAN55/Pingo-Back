<select id="findNearbyUsers" resultType="com.pingo.dto.profile.MainProfileResponseDTO">
    WITH TARGET_USER AS (
    -- 1. 내 위치와 내 성별을 한 번에 가져옵니다.
    SELECT UL."LOCATION", U."userGender"
    FROM "USER_LOCATIONS" UL
    JOIN "users" U ON UL."USERNO" = U."userNo"
    WHERE U."userNo" = #{userNo}
    )
    SELECT
    "u"."userNo",
    "u"."userName",
    "ui"."userBirth",
    '접속중' AS "status",
    -- 2. 하드코딩된 미국 좌표가 아닌, 내 위치(TU.LOCATION) 기준으로 거리를 계산합니다.
    TO_CHAR(
    SDO_GEOM.SDO_DISTANCE("ul"."LOCATION", TU."LOCATION", 0.005, 'unit=KM'),
    'FM990.00'
    ) || ' km' AS "distance",

    -- 3. 이미지는 리스트 형태로 묶어서 반환 (백엔드 DTO에서 List<String> 변환 처리 필요)
    (SELECT COALESCE(LISTAGG("img"."imageUrl", ',') WITHIN GROUP (ORDER BY "img"."imageUrl"), '')
    FROM "userImage" "img"
    WHERE "img"."userNo" = "u"."userNo") AS "images"

    FROM "users" "u"
    JOIN "userInfo" "ui" ON "u"."userNo" = "ui"."userNo"
    JOIN "USER_LOCATIONS" "ul" ON "u"."userNo" = "ul"."USERNO"
    CROSS JOIN TARGET_USER TU

    -- 4. 지정된 반경(distanceKm) 이내인지 확인
    WHERE SDO_WITHIN_DISTANCE("ul"."LOCATION", TU."LOCATION", 'distance=${distanceKm} unit=KM') = 'TRUE'
    AND "u"."userNo" != #{userNo} -- 나 자신 제외
    AND "u"."userGender" != TU."userGender" -- 이성만 매칭

    -- 5. ★ 가장 중요: DB에 실제로 저장되는 기본값으로 변경
    AND "u"."userState" = '1000'
    AND "u"."userRole" = 'ROLE_USER'

    -- 차단한 유저 제외
    AND NOT EXISTS (
    SELECT 1 FROM "userBlock" "ub"
    WHERE "ub"."fromUserNo" = #{userNo}
    AND "ub"."toUserNo" = "u"."userNo"
    )
    -- 내가 'PANG(싫어요/패스)' 했던 유저 제외 (PING이나 SUPERPING은 뜨게 됨)
    AND NOT EXISTS (
    SELECT 1 FROM "swipe" "s"
    WHERE "s"."fromUserNo" = #{userNo}
    AND "s"."toUserNo" = "u"."userNo"
    AND "s"."swipeType" = 'PANG'
    )
    -- 이미 매칭 완료된 유저 제외
    AND NOT EXISTS (
    SELECT 1 FROM "matchMapper" "mm"
    JOIN "matching" "m" ON "mm"."matchNo" = "m"."matchNo"
    WHERE "mm"."userNo" = #{userNo}
    AND "m"."matchState" = 'ACTIVE'
    AND "mm"."matchUserNo" = "u"."userNo"
    )
    ORDER BY SDO_GEOM.SDO_DISTANCE("ul"."LOCATION", TU."LOCATION", 0.005, 'unit=KM') ASC
</select>